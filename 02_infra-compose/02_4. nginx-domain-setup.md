# ğŸŒ NGINX ë„ë©”ì¸ ì—°ê²° ë° SSL ì¸ì¦ ì„¤ì • ê°€ì´ë“œ

---
## âœ… ê¸°ì¡´ systemctl NGINX êµ¬ì¡° -> sites-available / sites-enabled [Debian/Ubuntu ê³„ì—´ Nginx ì„¤ì •] ë°©ì‹.
```
/etc/nginx/
â”œâ”€â”€ nginx.conf
â”œâ”€â”€ sites-available/
â”‚   â”œâ”€â”€ default
â”‚   â””â”€â”€ your-subdomain.conf   
â”œâ”€â”€ sites-enabled/
â”‚   â””â”€â”€ default â†’ ../sites-available/default
```
âœ… sites-available/ ì—ì„œ ì„¤ì • íŒŒì¼ì„ ë§Œë“¤ê³ ,
âœ… sites-enabled/ ì— ì‹¬ë³¼ë¦­ ë§í¬ë§Œ ê±¸ê¸°

---

## ğŸ”§ í˜„ì¬ êµ¬ì¡° (ë„ì»¤ ì»´í¬ì¦ˆ ê¸°ë°˜)
### ğŸ—‚ï¸ í”„ë¡œì íŠ¸ êµ¬ì¡° ì˜ˆì‹œ (ê¸°ì¤€ ë””ë ‰í† ë¦¬: `/opt/home-server`)
Nginxë„ ë„ì»¤ ì•ˆì—ì„œ ìš´ì˜ ì¤‘ì´ë‹ˆê¹Œ,
ğŸ§Š Certbotë„ ë„ì»¤ ì»¨í…Œì´ë„ˆë¡œ í•¨ê»˜ ëŒë ¤ì•¼í•œë‹¤.  
volumesì„ ì—°ê²°í•´ì„œ í•´ë‹¹ ì¸ì¦ì„œë¥¼ opt í´ë”ì•ˆì— ë³´ê´€

```
/opt/home-server/
â”œâ”€â”€ nginx/
â”‚   â”œâ”€â”€ conf.d/                    # NGINX ì‚¬ì´íŠ¸ë³„ ì„¤ì •
â”‚   â”‚   â””â”€â”€ user.domain.com.conf       # core.abc.krìš© ì„¤ì • íŒŒì¼
â”‚   â”œâ”€â”€ certbot/
â”‚   â”‚   â”œâ”€â”€ www/                   # certbot ì¸ì¦ìš© íŒŒì¼ ì €ì¥ ê²½ë¡œ (webroot)
â”‚   â”‚   â””â”€â”€ conf/                  # certbotì—ì„œ ë°œê¸‰í•œ ì¸ì¦ì„œ ì €ì¥ ê²½ë¡œ
â”‚   â””â”€â”€ frontend/                  # í”„ë¡ íŠ¸ì—”ë“œ static íŒŒì¼
â”‚       â””â”€â”€ dist/
â”œâ”€â”€ docker-compose.yml            # Docker Compose ì„¤ì • íŒŒì¼
```

---

## âš™ï¸ `docker-compose.yml` í•µì‹¬ ì„¤ì •


```yaml
services:
  nginx:
    image: nginx:latest
    container_name: nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/conf.d:/etc/nginx/conf.d
      - ./nginx/certbot/www:/var/www/certbot
      - ./nginx/certbot/conf:/etc/letsencrypt
      - ./frontend/dist:/usr/share/nginx/html
    restart: always
    networks:
      - app-net

  certbot:
    image: certbot/certbot
    container_name: certbot
    volumes:
      - ./nginx/certbot/www:/var/www/certbot
      - ./nginx/certbot/conf:/etc/letsencrypt
    entrypoint: /bin/sh -c
    command: >
      certbot certonly --webroot --webroot-path=/var/www/certbot
      --email kimjs5284@daum.com --agree-tos --no-eff-email
      -d user.domain.com
    depends_on:
      - nginx

networks:
  app-net:
    driver: bridge
```
```bash
docker compose up -d  # ë„ì»¤ ì»´í¬ì¦ˆ ì‹¤í–‰ (ë°±ê·¸ë¼ìš´ë“œë¡œ)
docker compose ps     # ì‹¤í–‰ í™•ì¸
docker logs nginx | tail -n 50    # Nginx ì»¨í…Œì´ë„ˆ ë¡œê·¸ í™•ì¸

docker compose restart nginx
docker compose run certbot
#1íšŒ ì‹¤í–‰ í›„ ì¢…ë£Œë¨ (Exited)
#ê·¸ë˜ì„œ upê³¼ ë‹¬ë¦¬ logs ëª…ë ¹ìœ¼ë¡œ ì ‘ê·¼ ì•ˆ ë¨

docker compose run certbot renew # ì¸ì¦ì„œ ë§Œë£Œ ì „ ìë™ë°œê¸‰
certbot renew --dry-run #ì¸ì¦ì„œ ìƒê¸°ë©´ cronìœ¼ë¡œ ê°±ì‹  ìë™í™”
```
---

## ğŸ“„ `user.domain.com.conf` (NGINX ê°€ìƒ í˜¸ìŠ¤íŠ¸ ì„¤ì •)

```nginx
server {
    listen 80;
    server_name core.abc.kr;

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
        #alias /var/www/certbot/; # aliasë¥¼ ì“°ë©´ .well-known/acme-challenge/ëŠ” ë¬´ì‹œë˜ê³ ,
                                  # ê²½ë¡œ ìì²´ê°€ /var/www/certbot/test.txtë¡œ ë§¤í•‘
    }

    location / {
        return 301 https://$host$request_uri;
    }
}

server {
    listen 443 ssl;
    server_name core.abc.kr;

    ssl_certificate /etc/letsencrypt/live/core.abc.kr/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/core.abc.kr/privkey.pem;

    location / {
        root /usr/share/nginx/html;
        index index.html;
    }
}
```

---

### ğŸš« Docker compose ì‹¤íŒ¨ certbot ì— ì§ì ‘ ë“¤ì–´ê°€ì„œ ì¸ì¦ì„œ ë°œê¸‰
docker compose run certbot ìœ¼ë¡œ ì‹¤í–‰
ë¡œê·¸ëŠ” ì»¨í…Œì´ë„ˆ ì•ˆì—ì„œë§Œ ë‚¨ê³ , ë°–ì—ì„œëŠ” ì•ˆ ë³´ì„
ì‹¤íŒ¨í•´ë„ ì™œ ì‹¤íŒ¨í–ˆëŠ”ì§€ í™•ì¸ì´ ì–´ë ¤ì›€
certbotì´ ë­”ê°€ ë¹ ì§€ê±°ë‚˜, nginxê°€ ëŠ¦ê²Œ ëœ¨ê±°ë‚˜, ë³¼ë¥¨ ë§ˆìš´íŠ¸ íƒ€ì´ë° ì•ˆ ë§ìœ¼ë©´ ì¡°ìš©íˆ ì‹¤íŒ¨
#### âš ï¸ 1ê°œì”© ë°œê¸‰í•´ì•¼í•¨ 2ê°œ ì´ìƒë¶€í„° ì—ëŸ¬ë‚¨

---
## ğŸ” ì¸ì¦ì„œ ë°œê¸‰ ì ˆì°¨ (manual)

```bash
docker run -it --rm \
  --entrypoint sh \
  --network home-server_app-net \
  -v "$PWD/nginx/certbot/www:/var/www/certbot" \
  -v "$PWD/nginx/certbot/conf:/etc/letsencrypt" \
  certbot/certbot

# ì§„ì… í›„ certbot ì§ì ‘ ì‹¤í–‰
certbot certonly --webroot --webroot-path=/var/www/certbot \
  --email kimjs5284@daum.com --agree-tos --no-eff-email \
  -d user.domain.com --debug-challenges -v
```

---

## âœ… ë°œê¸‰ ì™„ë£Œ í›„ í™•ì¸

```bash
ls ./nginx/certbot/conf/live/user.domain.com/
# fullchain.pem, privkey.pem íŒŒì¼ì´ ì¡´ì¬í•˜ë©´ ì„±ê³µ!
```

---

## ğŸ” nginx ì¬ì‹œì‘

```bash
docker compose restart nginx
```

---

## ğŸ“Œ ê¸°íƒ€ íŒ

- `access_log`ì´ ë„ì»¤ ë¡œê·¸ë¡œ ì•ˆ ë‚˜ì˜¤ëŠ” ê²½ìš°:
  ```nginx
  docker exec -it nginx cat /etc/nginx/nginx.conf | grep access_log
  docker exec -it nginx cat /var/log/nginx/access.log
  docker exec -it nginx tail -n 50 /var/log/nginx/access.log
  docker exec -it nginx grep access_log /etc/nginx/conf.d/*.conf
  
  access_log /var/log/nginx/access.log;
  ```

- ì‹¤ì œ ì ‘ê·¼ ë¡œê·¸ëŠ” ë‹¤ìŒ ëª…ë ¹ìœ¼ë¡œ í™•ì¸:
  ```bash
  docker exec -it nginx tail -n 50 /var/log/nginx/access.log
  ```

---
_Last Updated: 2025-04-18 00:54:28_
